<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversor de Fatura BB para CSV</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- √çcones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Estilos para transi√ß√µes e detalhes espec√≠ficos */
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.5s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        .drag-active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        /* Dark mode drag active */
        .dark .drag-active {
            background-color: #1e3a8a;
            /* blue-900 */
            border-color: #60a5fa;
            /* blue-400 */
        }

        .table-input {
            background: transparent;
            width: 100%;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .table-input:focus {
            background: white;
            border-color: #bfdbfe;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .dark .table-input:focus {
            background: #1f2937;
            /* gray-800 */
            border-color: #3b82f6;
            color: #f3f4f6;
        }

        .table-input:hover {
            background: #f8fafc;
        }

        .dark .table-input:hover {
            background: #374151;
            /* gray-700 */
        }

        /* Toggle Switch Style */
        /* Ajuste crucial: use 'transform' para mover a bolinha, garantindo a transi√ß√£o */
        .toggle-checkbox {
            left: 1px;
            /* Ajusta a posi√ß√£o inicial */
            transition: transform 0.2s ease-in-out, border-color 0.2s ease-in-out;
            width: 18px;
            /* Ajusta largura para encaixar */
            height: 18px;
            /* Ajusta altura para encaixar */
        }

        .toggle-checkbox:checked {
            transform: translateX(18px);
            /* Move 18px (largura da bolinha + margem) para a direita */
            border-color: #10b981;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #10b981;
        }

        .toggle-label {
            height: 20px;
            /* Altura do trilho */
            width: 40px;
            /* Largura do trilho */
        }
    </style>
</head>

<body
    class="bg-gray-50 text-gray-800 font-sans min-h-screen transition-colors duration-300 dark:bg-gray-900 dark:text-gray-100">

    <div id="app" class="container mx-auto px-4 py-8 max-w-5xl">

        <!-- Header -->
        <header class="mb-8 text-center relative">
            <!-- Dark Mode Toggle (Absolute Top Right) -->
            <button @click="toggleDarkMode"
                class="absolute top-0 right-0 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
                :title="isDarkMode ? 'Mudar para modo claro' : 'Mudar para modo escuro'">
                <span v-html="darkModeIcon"></span>
            </button>

            <h1 class="text-3xl font-bold text-blue-900 dark:text-blue-400 mb-2 flex justify-center items-center gap-2">
                <i data-lucide="file-spreadsheet" class="w-8 h-8"></i>
                Conversor de Fatura BB
            </h1>
            <p class="text-gray-600 dark:text-gray-400">
                Transforme o PDF da sua fatura do Banco do Brasil em uma tabela edit√°vel e baixe em CSV.
                <br>
                <span
                    class="text-xs text-green-600 dark:text-green-400 font-semibold bg-green-100 dark:bg-green-900/30 px-2 py-1 rounded-full mt-2 inline-block">
                    üîí 100% Local - Seus dados n√£o s√£o enviados para nenhum servidor.
                </span>
            </p>
        </header>

        <!-- Upload Area -->
        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-10 text-center cursor-pointer transition-all duration-300 bg-white dark:bg-gray-800 shadow-sm hover:shadow-md mb-8"
            :class="{ 'drag-active': isDragging }" @dragover.prevent="isDragging = true"
            @dragleave.prevent="isDragging = false" @drop.prevent="handleDrop" @click="triggerFileInput">
            <input type="file" ref="fileInput" class="hidden" accept="application/pdf" @change="handleFileSelect">

            <div v-if="!isProcessing">
                <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto text-blue-400 mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200">Arraste sua fatura PDF aqui</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Ou clique para selecionar o arquivo</p>
            </div>

            <div v-else class="flex flex-col items-center justify-center">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 dark:border-blue-400 mb-4">
                </div>
                <p class="text-blue-600 dark:text-blue-400 font-medium">Lendo PDF e extraindo lan√ßamentos...</p>
                <p class="text-xs text-gray-400 mt-2">Processando p√°gina {{ progress.current }} de {{ progress.total }}
                </p>
            </div>
        </div>

        <!-- Error Message -->
        <div v-if="errorMessage"
            class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-4 mb-8 rounded shadow-sm flex items-start gap-3">
            <i data-lucide="alert-circle" class="text-red-500 w-5 h-5 mt-0.5"></i>
            <div>
                <p class="font-bold text-red-700 dark:text-red-400">Erro</p>
                <p class="text-red-600 dark:text-red-300">{{ errorMessage }}</p>
            </div>
            <button @click="errorMessage = null"
                class="ml-auto text-red-400 hover:text-red-700 dark:hover:text-red-300">‚úï</button>
        </div>

        <!-- Editor Section -->
        <transition name="fade">
            <div v-if="transactions.length > 0"
                class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-200 dark:border-gray-700">

                <!-- Toolbar -->
                <div
                    class="p-4 bg-gray-50 dark:bg-gray-900/50 border-b border-gray-200 dark:border-gray-700 flex flex-wrap justify-between items-center gap-4">

                    <!-- Stats & Toggle -->
                    <div class="flex items-center gap-6">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-700 dark:text-gray-200">{{ transactions.length }}</span>
                            <span class="text-gray-500 dark:text-gray-400 text-sm">lan√ßamentos</span>
                        </div>

                        <!-- Toggle Switch -->
                        <div class="flex items-center gap-2 border-l pl-6 border-gray-300 dark:border-gray-600">
                            <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Inverter Sinais</span>
                            <div
                                class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="toggle" v-model="isInverted"
                                    @change="handleInvertToggle"
                                    class="toggle-checkbox absolute block rounded-full bg-white border-4 appearance-none cursor-pointer" />
                                <label for="toggle"
                                    class="toggle-label block overflow-hidden rounded-full bg-gray-300 dark:bg-gray-600 cursor-pointer transition-colors duration-200 ease-in-out"></label>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-2">
                        <button @click="addTransaction"
                            class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors text-sm font-medium shadow-sm">
                            <i data-lucide="plus" class="w-4 h-4"></i> <span class="hidden sm:inline">Adicionar</span>
                        </button>
                        <button @click="downloadCSV"
                            class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium shadow-sm">
                            <i data-lucide="download" class="w-4 h-4"></i> Baixar CSV
                        </button>
                        <button @click="reset"
                            class="flex items-center gap-2 px-4 py-2 text-gray-400 hover:text-red-500 transition-colors text-sm"
                            title="Limpar tudo">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr
                                class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs uppercase tracking-wider">
                                <th class="p-4 font-semibold w-32">Data</th>
                                <th class="p-4 font-semibold">Descri√ß√£o</th>
                                <th class="p-4 font-semibold w-20 text-center">Moeda</th>
                                <th class="p-4 font-semibold w-40 text-right">Valor</th>
                                <th class="p-4 w-16 text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                            <tr v-for="(item, index) in transactions" :key="index"
                                class="hover:bg-blue-50 dark:hover:bg-gray-700/50 group transition-colors">
                                <td class="p-2">
                                    <input type="text" v-model="item.date"
                                        class="table-input text-gray-600 dark:text-gray-300 font-mono text-sm"
                                        placeholder="DD/MM">
                                </td>
                                <td class="p-2">
                                    <input type="text" v-model="item.description"
                                        class="table-input font-medium text-gray-800 dark:text-gray-100"
                                        placeholder="Descri√ß√£o da compra">
                                </td>
                                <!-- Coluna Moeda Separada -->
                                <td class="p-2 text-center">
                                    <input type="text" v-model="item.currency"
                                        class="table-input text-center text-gray-500 dark:text-gray-400 text-sm w-full"
                                        readonly>
                                </td>
                                <!-- Coluna Valor (sem R$) -->
                                <td class="p-2 text-right">
                                    <input type="text" v-model="item.value"
                                        class="table-input text-right font-mono text-sm"
                                        :class="item.type === 'credit' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'"
                                        placeholder="0,00">
                                </td>
                                <td class="p-2 text-center">
                                    <button @click="removeTransaction(index)"
                                        class="text-gray-300 hover:text-red-500 p-1 rounded transition-colors"
                                        title="Remover linha">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot class="bg-gray-50 dark:bg-gray-900/50">
                            <tr>
                                <td colspan="3" class="p-4 text-right font-bold text-gray-600 dark:text-gray-400">Total
                                    Calculado (Aprox.):
                                </td>
                                <td class="p-4 text-right font-bold text-blue-900 dark:text-blue-400 font-mono">{{
                                    calculatedTotal }}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </transition>

        <!-- Empty State Helper -->
        <div v-if="transactions.length === 0 && !isProcessing && !errorMessage"
            class="mt-12 text-center text-gray-400 text-sm">
            <p>Compat√≠vel com faturas em PDF do Banco do Brasil (Ourocard).</p>
            <p>O sistema busca padr√µes como "DD/MM Descri√ß√£o Valor".</p>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, nextTick, onMounted, watch } = Vue;

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        createApp({
            setup() {
                const transactions = ref([]);
                const isDragging = ref(false);
                const isProcessing = ref(false);
                const fileInput = ref(null);
                const errorMessage = ref(null);
                const progress = ref({ current: 0, total: 0 });
                const isInverted = ref(false);
                const isDarkMode = ref(false);

                // --- Dark Mode ---

                const toggleDarkMode = () => {
                    isDarkMode.value = !isDarkMode.value;
                    updateTheme();
                };

                const updateTheme = () => {
                    if (isDarkMode.value) {
                        document.documentElement.classList.add('dark');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                        localStorage.setItem('theme', 'light');
                    }
                    // Re-render icons because color classes might have changed
                    nextTick(() => lucide.createIcons());
                };

                const darkModeIcon = computed(() => {
                    if (isDarkMode.value) {
                        // Sun icon SVG
                        return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-yellow-400"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>';
                    } else {
                        // Moon icon SVG
                        return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-gray-600"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>';
                    }
                });

                // Initialize theme
                onMounted(() => {
                    const savedTheme = localStorage.getItem('theme');
                    const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

                    if (savedTheme === 'dark' || (!savedTheme && systemDark)) {
                        isDarkMode.value = true;
                    } else {
                        isDarkMode.value = false;
                    }
                    updateTheme();
                    lucide.createIcons();
                });

                // --- Utils ---

                const triggerFileInput = () => {
                    fileInput.value.click();
                };

                const reset = () => {
                    transactions.value = [];
                    errorMessage.value = null;
                    isInverted.value = false;
                    if (fileInput.value) fileInput.value.value = '';
                };

                // --- Parsing Num√©rico ---

                const parsePtBrFloat = (str) => {
                    // Remove qualquer coisa que n√£o seja n√∫mero, v√≠rgula, ponto ou tra√ßo
                    let clean = str.replace(/[^\d,.-]/g, '');

                    // Detecta sinal negativo no final (padr√£o BB: 100,00-)
                    let isNegative = clean.endsWith('-') || clean.startsWith('-');

                    // Remove o sinal para parsear
                    clean = clean.replace(/-/g, '');

                    // Troca ponto de milhar por nada e v√≠rgula por ponto
                    clean = clean.replace(/\./g, '').replace(',', '.');

                    let val = parseFloat(clean);
                    if (isNaN(val)) return 0;

                    return isNegative ? -val : val;
                };

                const formatPtBrFloat = (num) => {
                    return num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                };

                // --- Invers√£o de Sinais ---

                const handleInvertToggle = () => {
                    // Itera sobre todas as transa√ß√µes e inverte o sinal matematicamente
                    transactions.value.forEach(item => {
                        const val = parsePtBrFloat(item.value);
                        const inverted = val * -1;
                        // Atualiza o valor na tabela com o sinal invertido
                        item.value = formatPtBrFloat(inverted);
                    });
                };

                // --- Manipula√ß√£o de Arquivo ---

                const handleDrop = (e) => {
                    isDragging.value = false;
                    const files = e.dataTransfer.files;
                    if (files.length) processFile(files[0]);
                };

                const handleFileSelect = (e) => {
                    const files = e.target.files;
                    if (files.length) processFile(files[0]);
                };

                const processFile = async (file) => {
                    if (file.type !== 'application/pdf') {
                        errorMessage.value = "Por favor, envie apenas arquivos PDF.";
                        return;
                    }

                    reset(); // Limpa estado anterior
                    isProcessing.value = true;
                    progress.value = { current: 0, total: 0 };

                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        progress.value.total = pdf.numPages;

                        let allTextLines = [];

                        for (let i = 1; i <= pdf.numPages; i++) {
                            progress.value.current = i;
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const lines = groupTextByLine(textContent.items);
                            allTextLines = [...allTextLines, ...lines];
                        }

                        parseLines(allTextLines);

                        if (transactions.value.length === 0) {
                            errorMessage.value = "N√£o foi poss√≠vel identificar lan√ßamentos automaticamente.";
                        }

                    } catch (err) {
                        console.error(err);
                        errorMessage.value = "Erro ao processar o PDF. Verifique se o arquivo n√£o possui senha.";
                    } finally {
                        isProcessing.value = false;
                        nextTick(() => lucide.createIcons());
                    }
                };

                const groupTextByLine = (items) => {
                    items.sort((a, b) => {
                        if (Math.abs(a.transform[5] - b.transform[5]) > 5) {
                            return b.transform[5] - a.transform[5];
                        }
                        return a.transform[4] - b.transform[4];
                    });

                    const lines = [];
                    let currentLine = [];
                    let lastY = null;

                    items.forEach(item => {
                        const y = item.transform[5];
                        if (lastY === null || Math.abs(y - lastY) > 5) {
                            if (currentLine.length > 0) lines.push(currentLine.join(' '));
                            currentLine = [];
                            lastY = y;
                        }
                        currentLine.push(item.str);
                    });
                    if (currentLine.length > 0) lines.push(currentLine.join(' '));
                    return lines;
                };

                const parseLines = (lines) => {
                    const regexTransaction = /^(\d{2}\/\d{2})\s+(.*?)\s+(R\$\s?-?[\d\.,]+-?)$/;
                    let isFutureInstallments = false;

                    lines.forEach(line => {
                        const cleanLine = line.replace(/\s+/g, ' ').trim();

                        if (cleanLine.toLowerCase().includes('parcelamentos pr√≥xima fatura') ||
                            cleanLine.toLowerCase().includes('parcelamentos proxima fatura')) {
                            isFutureInstallments = true;
                        }
                        if (isFutureInstallments) return;

                        const match = cleanLine.match(regexTransaction);

                        if (match) {
                            let description = match[2].trim();
                            let rawValue = match[3].trim();

                            if (description.endsWith(' BR')) {
                                description = description.slice(0, -3);
                            }

                            if (description.toLowerCase().includes('saldo anterior') || description.toLowerCase().includes('total')) {
                                return;
                            }

                            // Limpa o "R$" e mant√©m apenas o n√∫mero (podendo ter sinal) para a coluna Valor
                            // Ex: "R$ 100,00-" vira "100,00-"
                            let cleanValue = rawValue.replace('R$', '').trim();

                            // Detecta se √© cr√©dito (negativo) ou d√©bito (positivo) pelo sinal original
                            const isCredit = cleanValue.includes('-');

                            transactions.value.push({
                                date: match[1],
                                description: description,
                                currency: 'R$',
                                value: cleanValue,
                                type: isCredit ? 'credit' : 'debit'
                            });
                        }
                    });
                };

                // --- Manipula√ß√£o de Dados UI ---

                const addTransaction = () => {
                    transactions.value.unshift({ date: '', description: '', currency: 'R$', value: '', type: 'debit' });
                };

                const removeTransaction = (index) => {
                    transactions.value.splice(index, 1);
                };

                const calculatedTotal = computed(() => {
                    let total = 0;
                    transactions.value.forEach(t => {
                        total += parsePtBrFloat(t.value);
                    });
                    return total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                });

                // --- Exporta√ß√£o ---

                const downloadCSV = () => {
                    if (transactions.value.length === 0) return;

                    const BOM = "\uFEFF";
                    let csvContent = "Data;Descri√ß√£o;Moeda;Valor\n";

                    transactions.value.forEach(row => {
                        const desc = row.description.replace(/"/g, '""');

                        // A exporta√ß√£o usa o valor exato que est√° na tabela (j√° invertido se o toggle estiver on)
                        // Apenas garantimos que o sinal de negativo fique sempre √† esquerda para o Excel entender
                        const valFloat = parsePtBrFloat(row.value);
                        const valString = valFloat.toLocaleString('pt-BR', { minimumFractionDigits: 2 });

                        const line = `"${row.date}";"${desc}";"${row.currency}";"${valString}"`;
                        csvContent += line + "\n";
                    });

                    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.setAttribute("href", url);
                    link.setAttribute("download", "fatura_exportada.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };

                watch(transactions, () => {
                    nextTick(() => lucide.createIcons());
                }, { deep: true });

                return {
                    isDragging,
                    isProcessing,
                    handleDrop,
                    handleFileSelect,
                    fileInput,
                    triggerFileInput,
                    transactions,
                    errorMessage,
                    addTransaction,
                    removeTransaction,
                    downloadCSV,
                    calculatedTotal,
                    reset,
                    progress,
                    isInverted,
                    handleInvertToggle,
                    isDarkMode,
                    toggleDarkMode,
                    darkModeIcon
                };
            }
        }).mount('#app');
    </script>
</body>

</html>